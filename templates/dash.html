<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 Advanced Crypto Trading Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        },
                        success: {
                            50: '#ecfdf5',
                            100: '#d1fae5',
                            200: '#a7f3d0',
                            300: '#6ee7b7',
                            400: '#34d399',
                            500: '#10b981',
                            600: '#059669',
                            700: '#047857',
                            800: '#065f46',
                            900: '#064e3b',
                        },
                        danger: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                            800: '#991b1b',
                            900: '#7f1d1d',
                        },
                        dark: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s ease-in-out infinite',
                        'bounce-slow': 'bounce 2s infinite',
                        'spin-slow': 'spin 3s linear infinite',
                        'flash': 'flash 0.5s ease-in-out',
                    },
                    keyframes: {
                        flash: {
                            '0%, 100%': { opacity: '0' },
                            '50%': { opacity: '1' },
                        }
                    }
                }
            },
            darkMode: 'class',
        }
    </script>
    <style>
        body {
            background: radial-gradient(ellipse at top, #0f1629 0%, #020617 50%, #000 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .glass-card {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(30, 41, 59, 0.6) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .positive {
            color: #10b981 !important;
        }
        
        .negative {
            color: #ef4444 !important;
        }
        
        .loading-skeleton {
            background: linear-gradient(90deg, rgba(148, 163, 184, 0.1) 25%, rgba(148, 163, 184, 0.2) 50%, rgba(148, 163, 184, 0.1) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .scroll-container {
            scrollbar-width: thin;
            scrollbar-color: rgba(148, 163, 184, 0.3) transparent;
        }
        
        .scroll-container::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .scroll-container::-webkit-scrollbar-track {
            background: rgba(148, 163, 184, 0.1);
            border-radius: 3px;
        }
        
        .scroll-container::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.3);
            border-radius: 3px;
        }
        
        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.5);
        }
        
        .pulse-update {
            animation: pulse 0.5s ease-in-out;
        }
        
        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }
        
        .metric-card-positive {
            border-left: 4px solid #10b981;
        }
        
        .metric-card-negative {
            border-left: 4px solid #ef4444;
        }
        
        .price-flash {
            animation: flash 0.3s ease-in-out;
        }
        
        @media (max-width: 768px) {
            .mobile-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .mobile-table table {
                min-width: 100%;
            }
        }
    </style>
</head>
<body class="bg-dark-950 text-slate-100 font-sans overflow-x-hidden">
    <div class="min-h-screen p-4 sm:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto space-y-6">
            <!-- Header -->
            <div class="glass-card rounded-2xl p-6 sm:p-8 relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-r from-primary-500/10 via-transparent to-success-500/10 pointer-events-none"></div>
                <div class="relative z-10">
                    <div class="text-center">
                        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold bg-gradient-to-r from-primary-400 via-purple-400 to-success-400 bg-clip-text text-transparent mb-4">
                            <i class="fas fa-rocket mr-3"></i>Advanced Crypto Trading Hub
                        </h1>
                        
                        <!-- System Status -->
                        <div class="flex flex-wrap justify-center items-center gap-4 sm:gap-6 mb-6 p-4 bg-slate-800/50 rounded-xl border border-slate-700/50">
                            <div class="flex items-center gap-2 text-sm">
                                <i class="fas fa-circle text-success-500 animate-pulse" id="statusIndicator"></i>
                                <span>System: <span id="systemStatus" class="font-semibold">Starting...</span></span>
                            </div>
                            <div class="flex items-center gap-2 text-sm">
                                <i class="fas fa-clock text-slate-400"></i>
                                <span>Uptime: <span id="systemUptime" class="font-semibold">0m</span></span>
                            </div>
                            <button onclick="openReadmeInNewPage()" class="px-4 py-2 bg-primary-600/20 text-primary-400 border border-primary-500/30 rounded-lg hover:bg-primary-600/30 transition-all duration-200 text-sm">
                                <i class="fas fa-book mr-2"></i>Documentation
                            </button>
                        </div>
                        
                        <!-- Connection Controls -->
                        <div class="flex flex-col sm:flex-row gap-4 items-center justify-center">
                            <div id="connectionStatus" class="px-4 py-2 rounded-full text-sm font-semibold bg-yellow-500/20 text-yellow-400 border border-yellow-500/30">
                                <span class="inline-block w-2 h-2 bg-yellow-400 rounded-full animate-pulse mr-2"></span>
                                Connecting to WebSocket...
                            </div>
                            <div class="flex gap-3">
                                <button id="connectBtn" onclick="connect()" disabled class="px-4 py-2 bg-success-600/20 text-success-400 border border-success-500/30 rounded-lg hover:bg-success-600/30 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fas fa-plug mr-2"></i>Connect
                                </button>
                                <button id="disconnectBtn" onclick="disconnect()" disabled class="px-4 py-2 bg-danger-600/20 text-danger-400 border border-danger-500/30 rounded-lg hover:bg-danger-600/30 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fas fa-unlink mr-2"></i>Disconnect
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Account Summary -->
            <div class="glass-card rounded-2xl p-6 relative">
                <div class="absolute top-4 right-4">
                    <div id="accountUpdateIndicator" class="w-3 h-3 bg-success-500 rounded-full opacity-0 transition-opacity duration-300"></div>
                </div>
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-slate-100 flex items-center gap-3">
                        <i class="fas fa-wallet text-primary-400"></i>
                        Account Summary
                    </h2>
                </div>
                <div id="accountSummary">
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4">
                        <div class="glass-effect rounded-xl p-4 text-center">
                            <div class="loading-skeleton h-4 w-20 mx-auto mb-2 rounded"></div>
                            <div class="loading-skeleton h-6 w-16 mx-auto rounded"></div>
                        </div>
                        <div class="glass-effect rounded-xl p-4 text-center">
                            <div class="loading-skeleton h-4 w-20 mx-auto mb-2 rounded"></div>
                            <div class="loading-skeleton h-6 w-16 mx-auto rounded"></div>
                        </div>
                        <div class="glass-effect rounded-xl p-4 text-center">
                            <div class="loading-skeleton h-4 w-20 mx-auto mb-2 rounded"></div>
                            <div class="loading-skeleton h-6 w-16 mx-auto rounded"></div>
                        </div>
                        <div class="glass-effect rounded-xl p-4 text-center">
                            <div class="loading-skeleton h-4 w-20 mx-auto mb-2 rounded"></div>
                            <div class="loading-skeleton h-6 w-16 mx-auto rounded"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Prices -->
            <div class="glass-card rounded-2xl p-6">
                <div class="mb-6">
                    <h2 class="text-xl font-bold text-slate-100 flex items-center gap-3">
                        <i class="fas fa-chart-line text-success-400"></i>
                        Live Prices
                    </h2>
                </div>
                <div id="livePrices" class="space-y-3 max-h-96 overflow-y-auto scroll-container">
                    <div class="text-center text-slate-400 py-8">
                        <i class="fas fa-spinner animate-spin text-2xl mb-2"></i>
                        <p>Waiting for price data...</p>
                    </div>
                </div>
            </div>

            <!-- Trading Positions - Full Width Section -->
                <div class="glass-card rounded-2xl p-6">
                    <div class="relative">
                        <div class="absolute top-0 right-0">
                            <div id="positionsUpdateIndicator" class="w-3 h-3 bg-success-500 rounded-full opacity-0 transition-opacity duration-300"></div>
                        </div>
                        <div class="mb-6">
                            <h2 class="text-xl font-bold text-slate-100 flex items-center gap-3">
                                <i class="fas fa-chart-area text-primary-400"></i>
                                Trading Positions
                            </h2>
                        </div>
                        
                        <!-- Position Tabs -->
                        <div class="flex border-b border-slate-700 mb-6" id="positionTabs">
                            <button class="tab-button px-4 py-2 font-medium text-slate-400 border-b-2 border-transparent hover:text-slate-200 transition-colors duration-200 tab-active" data-tab="open">
                                Open Positions
                            </button>
                            <button class="tab-button px-4 py-2 font-medium text-slate-400 border-b-2 border-transparent hover:text-slate-200 transition-colors duration-200" data-tab="closed">
                                Closed Positions
                            </button>
                            <button class="tab-button px-4 py-2 font-medium text-slate-400 border-b-2 border-transparent hover:text-slate-200 transition-colors duration-200" data-tab="trades">
                                Trades
                            </button>
                        </div>
                        
                        <!-- Tab Contents -->
                        <div id="openPositionsTab" class="tab-content">
                            <div id="openPositions" class="max-h-96 overflow-y-auto scroll-container">
                                <div class="text-center text-slate-400 py-8">No open positions</div>
                            </div>
                        </div>
                        
                        <div id="closedPositionsTab" class="tab-content hidden">
                            <!-- Filters for Closed Positions -->
                            <div class="mb-4 p-4 bg-slate-800/50 rounded-lg">
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                                    <input type="text" id="positionsSymbolFilter" class="px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 text-sm focus:border-primary-500 focus:ring-1 focus:ring-primary-500" placeholder="Symbol">
                                    <input type="text" id="positionsSearchFilter" class="px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 text-sm focus:border-primary-500 focus:ring-1 focus:ring-primary-500" placeholder="Search...">
                                    <select id="positionsOrderBy" class="px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 text-sm focus:border-primary-500 focus:ring-1 focus:ring-primary-500">
                                        <option value="created_at">Order by Date</option>
                                        <option value="symbol">Order by Symbol</option>
                                        <option value="pnl">Order by P&L</option>
                                        <option value="duration">Order by Duration</option>
                                    </select>
                                    <button id="applyPositionsFilters" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors duration-200 text-sm font-medium">Apply</button>
                                </div>
                            </div>
                            <div id="closedPositionsInTab" class="max-h-96 overflow-y-auto scroll-container">
                                <div class="text-center text-slate-400 py-8">
                                    <i class="fas fa-spinner animate-spin text-2xl mb-2"></i>
                                    <p>Loading closed positions...</p>
                                </div>
                            </div>
                            <div id="positionsPagination" class="flex justify-center items-center gap-2 mt-4"></div>
                        </div>

                        <div id="tradesTab" class="tab-content hidden">
                            <!-- Filters for Trades -->
                            <div class="mb-4 p-4 bg-slate-800/50 rounded-lg">
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                                    <input type="text" id="tradesSymbolFilter" class="px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 text-sm focus:border-primary-500 focus:ring-1 focus:ring-primary-500" placeholder="Symbol">
                                    <input type="text" id="tradesSearchFilter" class="px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 text-sm focus:border-primary-500 focus:ring-1 focus:ring-primary-500" placeholder="Search...">
                                    <select id="tradesOrderBy" class="px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 text-sm focus:border-primary-500 focus:ring-1 focus:ring-primary-500">
                                        <option value="created_at">Order by Date</option>
                                        <option value="symbol">Order by Symbol</option>
                                        <option value="pnl">Order by P&L</option>
                                        <option value="duration">Order by Duration</option>
                                    </select>
                                    <button id="applyTradesFilters" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors duration-200 text-sm font-medium">Apply</button>
                                </div>
                            </div>
                            <div id="tradesInTab" class="max-h-96 overflow-y-auto scroll-container">
                                <div class="text-center text-slate-400 py-8">No trades found</div>
                            </div>
                            <div id="tradesTabPagination" class="flex justify-center items-center gap-2 mt-4"></div>
                        </div>
                    </div>
                </div>

            <!-- Notifications and Signals -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Notifications -->
                <div class="glass-card rounded-2xl p-6">
                    <div class="mb-6">
                        <h2 class="text-xl font-bold text-slate-100 flex items-center gap-3">
                            <i class="fas fa-bell text-yellow-400"></i>
                            Notifications
                        </h2>
                    </div>
                    
                    <!-- Notification Tabs -->
                    <div class="flex border-b border-slate-700 mb-6" id="notificationsTabs">
                        <button class="notification-tab-button px-4 py-2 font-medium text-slate-400 border-b-2 border-transparent hover:text-slate-200 transition-colors duration-200 tab-active" data-tab="live">
                            Live
                        </button>
                        <button class="notification-tab-button px-4 py-2 font-medium text-slate-400 border-b-2 border-transparent hover:text-slate-200 transition-colors duration-200" data-tab="historical">
                            Historical
                        </button>
                    </div>
                    
                    <div id="liveNotifications" class="notification-tab-content">
                        <div id="liveNotificationsList" class="space-y-3 max-h-96 overflow-y-auto scroll-container">
                            <div class="text-center text-slate-400 py-8">No recent notifications</div>
                        </div>
                    </div>
                    
                    <div id="historicalNotifications" class="notification-tab-content hidden">
                        <!-- Notification Filters -->
                        <div class="mb-4 p-4 bg-slate-800/50 rounded-lg">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                <input type="text" id="notificationSearchFilter" class="px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 text-sm focus:border-primary-500 focus:ring-1 focus:ring-primary-500" placeholder="Search...">
                                <select id="notificationLevelFilter" class="px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 text-sm focus:border-primary-500 focus:ring-1 focus:ring-primary-500">
                                    <option value="">All Levels</option>
                                    <option value="info">Info</option>
                                    <option value="warning">Warning</option>
                                    <option value="error">Error</option>
                                    <option value="success">Success</option>
                                </select>
                                <button id="applyNotificationFilters" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors duration-200 text-sm font-medium">Apply</button>
                            </div>
                        </div>
                        <div id="historicalNotificationsList" class="space-y-3 max-h-96 overflow-y-auto scroll-container">
                            <div class="text-center text-slate-400 py-8">
                                <i class="fas fa-spinner animate-spin text-2xl mb-2"></i>
                                <p>Loading notifications...</p>
                            </div>
                        </div>
                        <div id="notificationsPagination" class="flex justify-center items-center gap-2 mt-4"></div>
                    </div>
                </div>

                <!-- Strategy Signals -->
                <div class="glass-card rounded-2xl p-6">
                    <div class="mb-6">
                        <h2 class="text-xl font-bold text-slate-100 flex items-center gap-3">
                            <i class="fas fa-bullseye text-purple-400"></i>
                            Strategy Signals
                        </h2>
                    </div>
                    
                    <!-- Signal Tabs -->
                    <div class="flex border-b border-slate-700 mb-6" id="signalTabs">
                        <button class="signal-tab-button px-4 py-2 font-medium text-slate-400 border-b-2 border-transparent hover:text-slate-200 transition-colors duration-200 tab-active" data-tab="live">
                            Live Signals
                        </button>
                        <button class="signal-tab-button px-4 py-2 font-medium text-slate-400 border-b-2 border-transparent hover:text-slate-200 transition-colors duration-200" data-tab="historical">
                            Historical
                        </button>
                    </div>
                    
                    <div id="liveSignalsTab" class="signal-tab-content">
                        <div id="strategySignals" class="space-y-3 max-h-96 overflow-y-auto scroll-container">
                            <div class="text-center text-slate-400 py-8">Waiting for signals...</div>
                        </div>
                    </div>
                    
                    <div id="historicalSignalsTab" class="signal-tab-content hidden">
                        <!-- Signal Filters -->
                        <div class="mb-4 p-4 bg-slate-800/50 rounded-lg">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                                <input type="text" id="signalsSymbolFilter" class="px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 text-sm focus:border-primary-500 focus:ring-1 focus:ring-primary-500" placeholder="Symbol">
                                <select id="signalsStrategyFilter" class="px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 text-sm focus:border-primary-500 focus:ring-1 focus:ring-primary-500">
                                    <option value="">All Strategies</option>
                                </select>
                                <input type="text" id="signalsSearchFilter" class="px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 text-sm focus:border-primary-500 focus:ring-1 focus:ring-primary-500" placeholder="Search...">
                                <button id="applySignalsFilters" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors duration-200 text-sm font-medium">Apply</button>
                            </div>
                        </div>
                        <div id="historicalSignalsList" class="space-y-3 max-h-96 overflow-y-auto scroll-container">
                            <div class="text-center text-slate-400 py-8">
                                <i class="fas fa-spinner animate-spin text-2xl mb-2"></i>
                                <p>Loading historical signals...</p>
                            </div>
                        </div>
                        <div id="signalsPagination" class="flex justify-center items-center gap-2 mt-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- README Modal -->
    <div id="readmeModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="glass-card rounded-2xl max-w-4xl max-h-[90vh] w-full overflow-y-auto scroll-container">
            <div class="flex items-center justify-between p-6 border-b border-slate-700">
                <div class="flex items-center gap-3">
                    <i class="fas fa-book text-primary-400"></i>
                    <h3 class="text-xl font-bold text-slate-100">Trading Dashboard Documentation</h3>
                </div>
                <button onclick="closeReadme()" class="p-2 text-slate-400 hover:text-slate-200 hover:bg-slate-700/50 rounded-lg transition-colors duration-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 text-slate-300 space-y-4">
                <div>
                    <h4 class="text-lg font-semibold text-slate-100 mb-2">Overview</h4>
                    <p>This advanced crypto trading dashboard provides real-time monitoring and management of your automated trading system.</p>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold text-slate-100 mb-2">Features</h4>
                    <ul class="list-disc list-inside space-y-1 ml-4">
                        <li><strong>Live Market Prices:</strong> Real-time price data for monitored cryptocurrency pairs</li>
                        <li><strong>Account Summary:</strong> Current balance, P&L, margin usage, and performance metrics</li>
                        <li><strong>Trading Positions:</strong> Track open, closed positions, and completed trades</li>
                        <li><strong>Live Notifications:</strong> Real-time alerts and system notifications</li>
                        <li><strong>Strategy Signals:</strong> Monitor trading strategy recommendations and signals</li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold text-slate-100 mb-2">Navigation</h4>
                    <ul class="list-disc list-inside space-y-1 ml-4">
                        <li><strong>Open Positions:</strong> View currently active trading positions</li>
                        <li><strong>Closed Positions:</strong> Browse historical completed positions with filtering</li>
                        <li><strong>Trades:</strong> Detailed trade history with comprehensive filtering options</li>
                        <li><strong>Live Notifications:</strong> Recent system alerts and trading notifications</li>
                        <li><strong>Historical Data:</strong> Use date filters to analyze past performance</li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold text-slate-100 mb-2">Performance Metrics</h4>
                    <ul class="list-disc list-inside space-y-1 ml-4">
                        <li><strong>Realized P&L:</strong> Profits/losses from closed positions</li>
                        <li><strong>Unrealized P&L:</strong> Current profits/losses from open positions</li>
                        <li><strong>Total P&L:</strong> Combined realized and unrealized profits/losses</li>
                        <li><strong>Win Rate:</strong> Percentage of profitable trades</li>
                        <li><strong>Account Growth:</strong> Total account performance over time</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        class TradingDashboard {
            constructor() {
                this.ws = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 1000;
                this.isConnected = false;
                this.connectionId = null;
                
                // Session management
                this.sessionId = this.getOrCreateSessionId();
                this.tabId = this.generateTabId();
                this.browserFingerprint = this.generateBrowserFingerprint();
                this.lastHeartbeat = Date.now();
                this.heartbeatInterval = null;
                
                // Connection state tracking
                this.connectionAttempts = new Map();
                this.isReconnecting = false;
                this.isConnecting = false;
                this.subscribed = false;
                this.reconnectTimeoutId = null;
                this.connectionMutex = false;
                
                // Data storage
                this.data = {
                    livePrices: {},
                    openPositions: [],
                    closedPositions: { data: [], pagination: {}, filters: {} },
                    positionsTabData: { data: [], pagination: {} },
                    positionsTabFilters: {},
                    tradesTabData: { data: [], pagination: {} },
                    tradesTabFilters: {},
                    signals: [],
                    signalsData: { historical: { data: [], pagination: {}, filters: {} } },
                    notifications: {
                        live: [],
                        historical: { data: [], pagination: {}, filters: {} }
                    },
                    accountSummary: {},
                    strategies: [],
                    strategiesData: { historical: { data: [], pagination: {}, filters: {} } },
                    systemInfo: {}
                };
                
                // REST API base URL
                this.apiBaseUrl = `http://${window.location.hostname}:8766/api`;
                
                // Current tabs
                this.currentNotificationTab = 'live';
                this.currentPositionTab = 'open';
                this.currentSignalTab = 'live';
                this.currentStrategyTab = 'live';
                
                // SSE connection
                this.sseSource = null;
                
                this.init();
            }
            
            getOrCreateSessionId() {
                let sessionId = sessionStorage.getItem('trading_session_id');
                if (!sessionId) {
                    sessionId = 'session_' + Math.random().toString(36).substring(2, 11) + '_' + Date.now();
                    sessionStorage.setItem('trading_session_id', sessionId);
                }
                return sessionId;
            }
            
            generateTabId() {
                return 'tab_' + Math.random().toString(36).substring(2, 11) + '_' + Date.now();
            }
            
            generateBrowserFingerprint() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillText('Browser fingerprint text', 2, 2);
                
                const fingerprint = [
                    navigator.userAgent,
                    navigator.language,
                    screen.width + 'x' + screen.height,
                    new Date().getTimezoneOffset(),
                    canvas.toDataURL()
                ].join('|');
                
                let hash = 0;
                for (let i = 0; i < fingerprint.length; i++) {
                    const char = fingerprint.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return 'fp_' + Math.abs(hash).toString(36);
            }
            
            init() {
                if (window.dashboardInitializing) {
                    console.warn('⚠️ Dashboard initialization already in progress, skipping...');
                    return;
                }
                window.dashboardInitializing = true;
                
                if (window.dashboard) {
                    console.log('⚠️ Dashboard already initialized, cleaning up...');
                    try {
                        window.dashboard.cleanupConnection();
                        if (window.dashboard.sseSource) {
                            window.dashboard.sseSource.close();
                        }
                    } catch (e) {
                        console.debug('Error during cleanup:', e);
                    }
                    window.dashboard = null;
                }
                
                this.connectWebSocket();
                this.setupEventListeners();
                this.loadClosedPositions();
                this.loadClosedPositionsForTab();
                this.loadHistoricalNotifications();
                this.loadStrategiesPerformance();
                this.connectSSE();
                
                setTimeout(() => {
                    this.addLiveNotification({
                        id: 'test_' + Date.now(),
                        message: 'Dashboard initialized successfully',
                        level: 'info',
                        title: 'System',
                        timestamp: new Date().toISOString()
                    });
                }, 2000);
                
                window.dashboard = this;
                window.dashboardInitializing = false;
            }
            
            connectWebSocket() {
                if (this.isConnecting || this.isReconnecting || (this.ws && this.ws.readyState === WebSocket.CONNECTING)) {
                    console.log('🔄 Connection attempt already in progress, skipping...');
                    return false;
                }
                
                if (this.isConnected && this.ws && this.ws.readyState === WebSocket.OPEN) {
                    console.log('✅ Already connected to WebSocket');
                    return true;
                }
                
                if (this.connectionMutex) {
                    console.log('🔒 Connection mutex active, skipping...');
                    return false;
                }
                
                this.connectionMutex = true;
                this.isConnecting = true;
                this.isReconnecting = false;
                
                try {
                    this.cleanupConnection();
                    
                    const wsUrl = `ws://${window.location.hostname}:8765`;
                    console.log(`🔌 Connecting to WebSocket: ${wsUrl}`);
                    
                    this.ws = new WebSocket(wsUrl);
                    
                    const connectionTimeout = setTimeout(() => {
                        if (this.ws.readyState === WebSocket.CONNECTING) {
                            console.log('Connection timeout, closing socket');
                            this.ws.close();
                        }
                    }, 10000);
                    
                    this.ws.onopen = () => {
                        clearTimeout(connectionTimeout);
                        console.log('✅ WebSocket connected successfully');
                        this.isConnected = true;
                        this.isConnecting = false;
                        this.isReconnecting = false;
                        this.connectionMutex = false;
                        this.subscribed = false;
                        this.reconnectAttempts = 0;
                        this.lastHeartbeat = Date.now();
                        this.updateConnectionStatus('connected');
                        
                        setTimeout(() => {
                            this.subscribeToChannels();
                        }, 100);
                        this.startHeartbeat();
                    };
                    
                    this.ws.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);
                            this.lastHeartbeat = Date.now();
                            this.handleMessage(message);
                        } catch (error) {
                            console.error('Error parsing WebSocket message:', error);
                        }
                    };
                    
                    this.ws.onclose = (event) => {
                        clearTimeout(connectionTimeout);
                        console.log(`❌ WebSocket disconnected (Code: ${event.code}, Reason: ${event.reason})`);
                        this.isConnected = false;
                        this.isConnecting = false;
                        this.isReconnecting = false;
                        this.connectionMutex = false;
                        this.subscribed = false;
                        this.updateConnectionStatus('disconnected');
                        
                        if (event.code !== 1000 && event.code !== 1001 && this.reconnectAttempts < this.maxReconnectAttempts) {
                            this.scheduleReconnect();
                        }
                    };
                    
                    this.ws.onerror = (error) => {
                        clearTimeout(connectionTimeout);
                        console.error('❌ WebSocket error:', error);
                        this.isConnecting = false;
                        this.isReconnecting = false;
                        this.connectionMutex = false;
                        this.updateConnectionStatus('disconnected');
                    };
                    
                    return true;
                    
                } catch (error) {
                    console.error('❌ Failed to create WebSocket connection:', error);
                    this.isConnecting = false;
                    this.isReconnecting = false;
                    this.connectionMutex = false;
                    this.updateConnectionStatus('disconnected');
                    this.scheduleReconnect();
                    return false;
                }
            }
            
            cleanupConnection() {
                if (this.reconnectTimeoutId) {
                    clearTimeout(this.reconnectTimeoutId);
                    this.reconnectTimeoutId = null;
                }
                
                if (this.ws) {
                    try {
                        this.ws.onopen = null;
                        this.ws.onmessage = null;
                        this.ws.onclose = null;
                        this.ws.onerror = null;
                        
                        if (this.ws.readyState === WebSocket.OPEN || this.ws.readyState === WebSocket.CONNECTING) {
                            this.ws.close(1000, 'Connection cleanup');
                        }
                    } catch (e) {
                        console.debug('Error during WebSocket cleanup:', e);
                    }
                    this.ws = null;
                }
                
                if (this.heartbeatInterval) {
                    clearInterval(this.heartbeatInterval);
                    this.heartbeatInterval = null;
                }
                
                if (this.reconnectTimeoutId) {
                    clearTimeout(this.reconnectTimeoutId);
                    this.reconnectTimeoutId = null;
                }
                
                this.subscribed = false;
            }

            connectSSE() {
                if (this.sseSource) {
                    this.sseSource.close();
                }

                try {
                    this.sseSource = new EventSource(`${this.apiBaseUrl}/events/stream`);
                    
                    this.sseSource.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleSSEEvent(data);
                        } catch (error) {
                            console.error('Error parsing SSE message:', error);
                        }
                    };

                    this.sseSource.onerror = (error) => {
                        console.error('SSE connection error:', error);
                        setTimeout(() => this.connectSSE(), 5000);
                    };
                } catch (error) {
                    console.error('Failed to connect SSE:', error);
                }
            }

            handleSSEEvent(data) {
                console.log('SSE Event:', data);
                
                switch (data.type) {
                    case 'closed_position_update':
                        this.loadClosedPositions();
                        break;
                    case 'notification_update':
                        this.loadHistoricalNotifications();
                        break;
                    case 'strategy_update':
                        this.loadStrategiesPerformance();
                        break;
                }
            }
            
            startHeartbeat() {
                this.heartbeatInterval = setInterval(() => {
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        this.ws.send(JSON.stringify({
                            type: 'ping',
                            timestamp: Date.now(),
                            sessionId: this.sessionId,
                            tabId: this.tabId
                        }));
                    }
                }, 30000);
            }
            
            subscribeToChannels() {
                if (this.subscribed) {
                    console.log('🔄 Already subscribed to channels, skipping...');
                    return;
                }
                
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    const subscribeMessage = {
                        type: 'subscribe',
                        channels: [
                            'live_prices',
                            'positions', 
                            'closed_position_update',
                            'notifications',
                            'strategy_signals',
                            'account_summary',
                            'heartbeat'
                        ],
                        sessionId: this.sessionId,
                        tabId: this.tabId,
                        browserFingerprint: this.browserFingerprint,
                        timestamp: Date.now(),
                        userAgent: navigator.userAgent.substring(0, 100)
                    };
                    
                    this.ws.send(JSON.stringify(subscribeMessage));
                    this.subscribed = true;
                    console.log('📡 Subscribed to all channels');
                } else {
                    console.error('❌ Cannot subscribe: WebSocket not ready');
                }
            }
            
            handleMessage(message) {
                console.log('Received message:', message.type, message.data);
                
                switch (message.type) {
                    case 'live_prices':
                        this.updateLivePrices(message.data);
                        break;
                    case 'positions':
                        this.updateOpenPositions(message.data);
                        break;
                    case 'closed_position_update':
                        this.loadClosedPositions();
                        break;
                    case 'strategy_signals':
                        this.addStrategySignal(message.data);
                        break;
                    case 'notifications':
                        console.log('📢 Received notification message:', message.data);
                        this.addLiveNotification(message.data);
                        break;
                    case 'account_summary':
                        this.updateAccountSummary(message.data);
                        break;
                    case 'system_status':
                        this.updateSystemStatus(message.data);
                        break;
                    case 'heartbeat':
                        if (message.data && message.data.system_info) {
                            this.updateSystemStatus(message.data.system_info);
                        }
                        break;
                    default:
                        console.log('Unknown message type:', message.type);
                }
            }
            
            updateLivePrices(prices) {
                console.log('🔄 Live prices updated:', prices);
                if (prices && typeof prices === 'object') {
                    this.data.livePrices = { ...this.data.livePrices, ...prices };
                    this.renderLivePrices();
                } else {
                    console.warn('Invalid live prices data received:', prices);
                }
            }
            
            updateOpenPositions(positionsData) {
                console.log('📈 Open positions updated:', positionsData);
                if (positionsData && positionsData.open_positions) {
                    this.data.openPositions = positionsData;
                } else if (Array.isArray(positionsData)) {
                    this.data.openPositions = { open_positions: positionsData };
                } else {
                    this.data.openPositions = { open_positions: [] };
                }
                this.renderOpenPositions();
                this.flashUpdateIndicator('positionsUpdateIndicator');
            }
            
            addStrategySignal(signal) {
                this.data.signals.unshift(signal);
                this.data.signals = this.data.signals.slice(0, 10);
                this.renderStrategySignals();
            }
            
            addLiveNotification(notification) {
                console.log('📢 Adding live notification:', notification);
                
                if (Array.isArray(notification)) {
                    notification.forEach(notif => {
                        this.data.notifications.live.unshift(notif);
                    });
                } else {
                    this.data.notifications.live.unshift(notification);
                }
                
                this.data.notifications.live = this.data.notifications.live.slice(0, 15);
                
                if (this.currentNotificationTab === 'live') {
                    this.renderLiveNotifications();
                }
            }
            
            updateAccountSummary(summary) {
                console.log('💰 Account summary updated:', summary);
                if (summary && typeof summary === 'object') {
                    this.data.accountSummary = summary;
                    this.renderAccountSummary();
                    this.flashUpdateIndicator('accountUpdateIndicator');
                } else {
                    console.warn('Invalid account summary data received:', summary);
                }
            }
            
            updateSystemStatus(systemInfo) {
                console.log('⚙️ System status updated:', systemInfo);
                if (systemInfo && typeof systemInfo === 'object') {
                    const statusElement = document.getElementById('systemStatus');
                    const uptimeElement = document.getElementById('systemUptime');
                    const statusIndicator = document.getElementById('statusIndicator');
                    
                    if (statusElement && systemInfo.status) {
                        statusElement.textContent = systemInfo.status;
                        
                        if (statusIndicator) {
                            statusIndicator.classList.remove('text-danger-500');
                            statusIndicator.classList.add('text-success-500');
                            if (systemInfo.status.toLowerCase().includes('error') || 
                                systemInfo.status.toLowerCase().includes('offline') ||
                                systemInfo.status.toLowerCase().includes('stopped')) {
                                statusIndicator.classList.remove('text-success-500');
                                statusIndicator.classList.add('text-danger-500');
                            }
                        }
                    }
                    
                    if (uptimeElement && (systemInfo.uptime || systemInfo.uptime_seconds)) {
                        if (systemInfo.uptime) {
                            uptimeElement.textContent = systemInfo.uptime;
                        } else if (systemInfo.uptime_seconds) {
                            uptimeElement.textContent = this.formatUptime(systemInfo.uptime_seconds);
                        }
                    }
                    
                    this.data.systemInfo = systemInfo;
                } else {
                    console.warn('Invalid system status data received:', systemInfo);
                }
            }
            
            // REST API methods
            async loadClosedPositions(page = 1) {
                try {
                    const filters = this.data.closedPositions.filters || {};
                    const params = new URLSearchParams({
                        page: page.toString(),
                        limit: '20',
                        ...filters
                    });

                    const response = await fetch(`${this.apiBaseUrl}/positions/closed?${params}`);
                    const data = await response.json();
                    
                    this.data.closedPositions.data = data.positions;
                    this.data.closedPositions.pagination = data.pagination;
                    this.renderClosedPositions();
                } catch (error) {
                    console.error('Error loading closed positions:', error);
                    this.showErrorState('closedPositions', 'Error loading closed positions');
                }
            }

            async loadHistoricalNotifications(page = 1) {
                try {
                    const filters = this.data.notifications.historical.filters || {};
                    const params = new URLSearchParams({
                        page: page.toString(),
                        limit: '20',
                        ...filters
                    });

                    const response = await fetch(`${this.apiBaseUrl}/notifications?${params}`);
                    const data = await response.json();
                    
                    this.data.notifications.historical.data = data.notifications;
                    this.data.notifications.historical.pagination = data.pagination;
                    
                    if (this.currentNotificationTab === 'historical') {
                        this.renderHistoricalNotifications();
                    }
                } catch (error) {
                    console.error('Error loading historical notifications:', error);
                    this.showErrorState('historicalNotificationsList', 'Error loading notifications');
                }
            }

            async loadStrategiesPerformance() {
                try {
                    const response = await fetch(`${this.apiBaseUrl}/strategies`);
                    const data = await response.json();
                    
                    this.data.strategies = data.strategies;
                    this.renderStrategiesPerformance();
                } catch (error) {
                    console.error('Error loading strategies:', error);
                }
            }

            async loadClosedPositionsForTab(page = 1) {
                try {
                    const filters = this.data.positionsTabFilters || {};
                    const params = new URLSearchParams({
                        page: page.toString(),
                        limit: '20',
                        ...filters
                    });

                    const response = await fetch(`${this.apiBaseUrl}/positions/closed?${params}`);
                    const data = await response.json();
                    
                    this.data.positionsTabData = {
                        data: data.positions,
                        pagination: data.pagination
                    };
                    this.renderClosedPositionsInTab();
                } catch (error) {
                    console.error('Error loading closed positions for tab:', error);
                    this.showErrorState('closedPositionsInTab', 'Error loading closed positions');
                }
            }

            async loadTradesForTab(page = 1) {
                try {
                    const filters = this.data.tradesTabFilters || {};
                    const params = new URLSearchParams({
                        page: page.toString(),
                        per_page: '20',
                        ...filters
                    });
                    
                    const response = await fetch(`${this.apiBaseUrl}/trades?${params}`);
                    const data = await response.json();
                    
                    this.data.tradesTabData = {
                        data: data.trades,
                        pagination: data.pagination
                    };
                    this.renderTradesInTab();
                } catch (error) {
                    console.error('Error loading trades for tab:', error);
                    this.showErrorState('tradesInTab', 'Error loading trades');
                }
            }

            async loadHistoricalSignals(page = 1) {
                try {
                    const filters = this.data.signalsData.historical.filters || {};
                    const params = new URLSearchParams({
                        page: page.toString(),
                        limit: '20',
                        ...filters
                    });

                    const response = await fetch(`${this.apiBaseUrl}/signals?${params}`);
                    const data = await response.json();
                    
                    this.data.signalsData.historical.data = data.signals || [];
                    this.data.signalsData.historical.pagination = data.pagination || {};
                    
                    if (this.currentSignalTab === 'historical') {
                        this.renderHistoricalSignals();
                    }
                } catch (error) {
                    console.error('Error loading historical signals:', error);
                    this.data.signalsData.historical.data = [];
                    if (this.currentSignalTab === 'historical') {
                        this.renderHistoricalSignals();
                    }
                }
            }
            
            // Tab switching methods with improved error handling
            switchPositionTab(tab) {
                this.currentPositionTab = tab;
                
                // Update tab appearance
                const tabButtons = document.querySelectorAll('.tab-button');
                const tabContents = document.querySelectorAll('.tab-content');
                
                tabButtons.forEach(btn => {
                    btn.classList.remove('tab-active');
                    if (btn.dataset.tab === tab) {
                        btn.classList.add('tab-active');
                    }
                });
                
                tabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                
                // Show the appropriate tab content
                const targetTab = document.getElementById(`${tab}${tab === 'trades' ? 'Tab' : 'PositionsTab'}`);
                if (targetTab) {
                    targetTab.classList.remove('hidden');
                }
                
                // Load appropriate data
                if (tab === 'open') {
                    this.renderOpenPositions();
                } else if (tab === 'closed') {
                    this.renderClosedPositionsInTab();
                    this.loadClosedPositionsForTab();
                } else if (tab === 'trades') {
                    this.renderTradesInTab();
                    this.loadTradesForTab();
                }
            }
            
            switchNotificationTab(tab) {
                this.currentNotificationTab = tab;
                
                const tabButtons = document.querySelectorAll('.notification-tab-button');
                const tabContents = document.querySelectorAll('.notification-tab-content');
                
                tabButtons.forEach(btn => {
                    btn.classList.remove('tab-active');
                    if (btn.dataset.tab === tab) {
                        btn.classList.add('tab-active');
                    }
                });
                
                tabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                
                document.getElementById(`${tab}Notifications`).classList.remove('hidden');
                
                if (tab === 'live') {
                    this.renderLiveNotifications();
                } else {
                    this.renderHistoricalNotifications();
                }
            }
            
            switchSignalTab(tab) {
                this.currentSignalTab = tab;
                
                const tabButtons = document.querySelectorAll('.signal-tab-button');
                const tabContents = document.querySelectorAll('.signal-tab-content');
                
                tabButtons.forEach(btn => {
                    btn.classList.remove('tab-active');
                    if (btn.dataset.tab === tab) {
                        btn.classList.add('tab-active');
                    }
                });
                
                tabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                
                document.getElementById(`${tab}SignalsTab`).classList.remove('hidden');
                
                if (tab === 'live') {
                    this.renderStrategySignals();
                } else {
                    this.renderHistoricalSignals();
                    this.loadHistoricalSignals();
                }
            }
            
            // Rendering methods
            renderLivePrices() {
                const container = document.getElementById('livePrices');
                const prices = this.data.livePrices;
                
                if (Object.keys(prices).length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-slate-400 py-8">
                            <i class="fas fa-spinner animate-spin text-2xl mb-2"></i>
                            <p>Waiting for price data...</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = Object.entries(prices).map(([symbol, data]) => {
                    const price = parseFloat(data.price || 0);
                    const change = parseFloat(data.change_24h || 0);
                    const changeClass = change >= 0 ? 'positive' : 'negative';
                    const changeSymbol = change >= 0 ? '+' : '';
                    
                    return `
                        <div class="glass-effect rounded-xl p-4 hover:bg-slate-700/50 transition-all duration-200">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-slate-100 font-mono">${symbol}</div>
                                    <div class="text-2xl font-bold font-mono text-primary-400">$${this.formatPrice(price)}</div>
                                </div>
                                <div class="text-right">
                                    <div class="px-3 py-1 rounded-full text-sm font-bold ${changeClass === 'positive' ? 'bg-success-500/20 text-success-400' : 'bg-danger-500/20 text-danger-400'}">
                                        ${changeSymbol}${change.toFixed(2)}%
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            renderOpenPositions() {
                const container = document.getElementById('openPositions');
                const positions = this.data.openPositions;
                
                if (!positions || (!Array.isArray(positions) && !positions.open_positions) || 
                    (Array.isArray(positions) && positions.length === 0) || 
                    (positions.open_positions && positions.open_positions.length === 0)) {
                    container.innerHTML = '<div class="text-center text-slate-400 py-8">No open positions</div>';
                    return;
                }
                
                const positionsList = Array.isArray(positions) ? positions : (positions.open_positions || []);
                
                if (window.innerWidth < 768) {
                    // Mobile view - card layout
                    container.innerHTML = positionsList.map(position => {
                        const pnl = parseFloat(position.pnl || 0);
                        const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                        const pnlSymbol = pnl >= 0 ? '+' : '';
                        const positionType = position.position_type || position.type || position.side || 'LONG';
                        const sideClass = positionType === 'LONG' ? 'positive' : 'negative';
                        
                        return `
                            <div class="glass-effect rounded-xl p-4 mb-4">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <div class="font-bold text-lg">${position.symbol}</div>
                                        <div class="text-sm ${sideClass}">${positionType}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-bold ${pnlClass}">${pnlSymbol}$${Math.abs(pnl).toFixed(2)}</div>
                                        <div class="text-sm ${pnlClass}">${pnlSymbol}${(position.pnl_percentage || 0).toFixed(2)}%</div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div>
                                        <div class="text-slate-400">Entry Price</div>
                                        <div class="font-semibold">$${this.formatPrice(position.entry_price || 0)}</div>
                                    </div>
                                    <div>
                                        <div class="text-slate-400">Current Price</div>
                                        <div class="font-semibold">$${this.formatPrice(position.current_price || position.entry_price || 0)}</div>
                                    </div>
                                    <div>
                                        <div class="text-slate-400">Quantity</div>
                                        <div class="font-semibold">${this.formatNumber(position.quantity || 0)}</div>
                                    </div>
                                    <div>
                                        <div class="text-slate-400">Leverage</div>
                                        <div class="font-semibold">${position.leverage || 1}x</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    // Desktop view - table layout
                    container.innerHTML = `
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-slate-700">
                                        <th class="text-left py-3 px-2 text-slate-400 font-medium">Symbol</th>
                                        <th class="text-left py-3 px-2 text-slate-400 font-medium">Type</th>
                                        <th class="text-left py-3 px-2 text-slate-400 font-medium">Entry</th>
                                        <th class="text-left py-3 px-2 text-slate-400 font-medium">Current</th>
                                        <th class="text-left py-3 px-2 text-slate-400 font-medium">Quantity</th>
                                        <th class="text-left py-3 px-2 text-slate-400 font-medium">PnL</th>
                                        <th class="text-left py-3 px-2 text-slate-400 font-medium">PnL %</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${positionsList.map(position => {
                                        const pnl = parseFloat(position.pnl || 0);
                                        const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                                        const pnlSymbol = pnl >= 0 ? '+' : '';
                                        const positionType = position.position_type || position.type || position.side || 'LONG';
                                        const sideClass = positionType === 'LONG' ? 'positive' : 'negative';
                                        
                                        return `
                                            <tr class="border-b border-slate-800 hover:bg-slate-800/50">
                                                <td class="py-3 px-2 font-bold">${position.symbol}</td>
                                                <td class="py-3 px-2"><span class="px-2 py-1 rounded text-xs font-bold ${sideClass === 'positive' ? 'bg-success-500/20 text-success-400' : 'bg-danger-500/20 text-danger-400'}">${positionType}</span></td>
                                                <td class="py-3 px-2 font-mono">$${this.formatPrice(position.entry_price || 0)}</td>
                                                <td class="py-3 px-2 font-mono">$${this.formatPrice(position.current_price || position.entry_price || 0)}</td>
                                                <td class="py-3 px-2 font-mono">${this.formatNumber(position.quantity || 0)}</td>
                                                <td class="py-3 px-2 font-mono font-bold ${pnlClass}">${pnlSymbol}$${Math.abs(pnl).toFixed(2)}</td>
                                                <td class="py-3 px-2 font-mono font-bold ${pnlClass}">${pnlSymbol}${(position.pnl_percentage || 0).toFixed(2)}%</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            }
            
            renderClosedPositionsInTab() {
                const container = document.getElementById('closedPositionsInTab');
                const positions = this.data.positionsTabData.data;
                
                if (!positions || positions.length === 0) {
                    container.innerHTML = '<div class="text-center text-slate-400 py-8">No closed positions found</div>';
                    return;
                }
                
                if (window.innerWidth < 768) {
                    // Mobile view - card layout
                    container.innerHTML = positions.map(position => {
                        const pnl = parseFloat(position.pnl || 0);
                        const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                        const pnlSymbol = pnl >= 0 ? '+' : '';
                        const positionType = position.position_type || position.type || 'LONG';
                        const typeClass = positionType === 'LONG' ? 'positive' : 'negative';
                        
                        return `
                            <div class="glass-effect rounded-xl p-4 mb-4">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <div class="font-bold text-lg">${position.symbol}</div>
                                        <div class="text-sm ${typeClass}">${positionType}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-bold ${pnlClass}">${pnlSymbol}$${Math.abs(pnl).toFixed(2)}</div>
                                        <div class="text-sm ${pnlClass}">${pnlSymbol}${(position.pnl_percentage || 0).toFixed(2)}%</div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div>
                                        <div class="text-slate-400">Entry Price</div>
                                        <div class="font-semibold">$${this.formatPrice(position.entry_price || 0)}</div>
                                    </div>
                                    <div>
                                        <div class="text-slate-400">Exit Price</div>
                                        <div class="font-semibold">$${this.formatPrice(position.exit_price || 0)}</div>
                                    </div>
                                    <div>
                                        <div class="text-slate-400">Quantity</div>
                                        <div class="font-semibold">${this.formatNumber(position.quantity || 0)}</div>
                                    </div>
                                    <div>
                                        <div class="text-slate-400">Duration</div>
                                        <div class="font-semibold">${position.duration || position.holding_time || 'N/A'}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    // Desktop view - table layout
                    container.innerHTML = `
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-slate-700">
                                        <th class="text-left py-3 px-2 text-slate-400 font-medium">Symbol</th>
                                        <th class="text-left py-3 px-2 text-slate-400 font-medium">Type</th>
                                        <th class="text-left py-3 px-2 text-slate-400 font-medium">Entry</th>
                                        <th class="text-left py-3 px-2 text-slate-400 font-medium">Exit</th>
                                        <th class="text-left py-3 px-2 text-slate-400 font-medium">PnL</th>
                                        <th class="text-left py-3 px-2 text-slate-400 font-medium">PnL %</th>
                                        <th class="text-left py-3 px-2 text-slate-400 font-medium">Duration</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${positions.map(position => {
                                        const pnl = parseFloat(position.pnl || 0);
                                        const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                                        const pnlSymbol = pnl >= 0 ? '+' : '';
                                        const positionType = position.position_type || position.type || 'LONG';
                                        const typeClass = positionType === 'LONG' ? 'positive' : 'negative';
                                        
                                        return `
                                            <tr class="border-b border-slate-800 hover:bg-slate-800/50">
                                                <td class="py-3 px-2 font-bold">${position.symbol}</td>
                                                <td class="py-3 px-2"><span class="px-2 py-1 rounded text-xs font-bold ${typeClass === 'positive' ? 'bg-success-500/20 text-success-400' : 'bg-danger-500/20 text-danger-400'}">${positionType}</span></td>
                                                <td class="py-3 px-2 font-mono">$${this.formatPrice(position.entry_price || 0)}</td>
                                                <td class="py-3 px-2 font-mono">$${this.formatPrice(position.exit_price || 0)}</td>
                                                <td class="py-3 px-2 font-mono font-bold ${pnlClass}">${pnlSymbol}$${Math.abs(pnl).toFixed(2)}</td>
                                                <td class="py-3 px-2 font-mono font-bold ${pnlClass}">${pnlSymbol}${(position.pnl_percentage || 0).toFixed(2)}%</td>
                                                <td class="py-3 px-2 text-sm">${position.duration || position.holding_time || 'N/A'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                this.renderPositionsTabPagination();
            }
            
            renderTradesInTab() {
                const container = document.getElementById('tradesInTab');
                const trades = this.data.tradesTabData.data;
                
                if (!trades || trades.length === 0) {
                    container.innerHTML = '<div class="text-center text-slate-400 py-8">No trades found</div>';
                    return;
                }
                
                if (window.innerWidth < 768) {
                    // Mobile view - card layout
                    container.innerHTML = trades.map(trade => {
                        const pnl = parseFloat(trade.realized_pnl || 0);
                        const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                        const pnlSymbol = pnl >= 0 ? '+' : '';
                        const timestamp = new Date(trade.exit_time || trade.timestamp).toLocaleString();
                        
                        return `
                            <div class="glass-effect rounded-xl p-4 mb-4">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <div class="font-bold text-lg">${trade.symbol}</div>
                                        <div class="text-sm text-slate-400">${timestamp}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-bold ${pnlClass}">${pnlSymbol}$${Math.abs(pnl).toFixed(2)}</div>
                                        <div class="text-sm ${trade.side === 'BUY' ? 'positive' : 'negative'}">${trade.side}</div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div>
                                        <div class="text-slate-400">Entry Price</div>
                                        <div class="font-semibold">$${this.formatPrice(trade.entry_price || 0)}</div>
                                    </div>
                                    <div>
                                        <div class="text-slate-400">Exit Price</div>
                                        <div class="font-semibold">$${this.formatPrice(trade.exit_price || 0)}</div>
                                    </div>
                                    <div>
                                        <div class="text-slate-400">Size</div>
                                        <div class="font-semibold">${this.formatNumber(trade.quantity || 0)}</div>
                                    </div>
                                    <div>
                                        <div class="text-slate-400">Strategy</div>
                                        <div class="font-semibold">${trade.strategy || 'Manual'}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    // Desktop view - table layout
                    container.innerHTML = `
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-slate-700">
                                        <th class="text-left py-3 px-2 text-slate-400 font-medium">Symbol</th>
                                        <th class="text-left py-3 px-2 text-slate-400 font-medium">Side</th>
                                        <th class="text-left py-3 px-2 text-slate-400 font-medium">Size</th>
                                        <th class="text-left py-3 px-2 text-slate-400 font-medium">Entry</th>
                                        <th class="text-left py-3 px-2 text-slate-400 font-medium">Exit</th>
                                        <th class="text-left py-3 px-2 text-slate-400 font-medium">P&L</th>
                                        <th class="text-left py-3 px-2 text-slate-400 font-medium">Strategy</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${trades.map(trade => {
                                        const pnl = parseFloat(trade.realized_pnl || 0);
                                        const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                                        const pnlSymbol = pnl >= 0 ? '+' : '';
                                        
                                        return `
                                            <tr class="border-b border-slate-800 hover:bg-slate-800/50">
                                                <td class="py-3 px-2 font-bold">${trade.symbol}</td>
                                                <td class="py-3 px-2"><span class="px-2 py-1 rounded text-xs font-bold ${trade.side === 'BUY' ? 'bg-success-500/20 text-success-400' : 'bg-danger-500/20 text-danger-400'}">${trade.side}</span></td>
                                                <td class="py-3 px-2 font-mono">${this.formatNumber(trade.quantity || 0)}</td>
                                                <td class="py-3 px-2 font-mono">$${this.formatPrice(trade.entry_price || 0)}</td>
                                                <td class="py-3 px-2 font-mono">$${this.formatPrice(trade.exit_price || 0)}</td>
                                                <td class="py-3 px-2 font-mono font-bold ${pnlClass}">${pnlSymbol}$${Math.abs(pnl).toFixed(2)}</td>
                                                <td class="py-3 px-2 text-sm">${trade.strategy || 'Manual'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                this.renderTradesInTabPagination();
            }
            
            renderLiveNotifications() {
                const container = document.getElementById('liveNotificationsList');
                const notifications = this.data.notifications.live;
                
                if (!notifications || notifications.length === 0) {
                    container.innerHTML = '<div class="text-center text-slate-400 py-8">No recent notifications</div>';
                    return;
                }
                
                container.innerHTML = notifications.map(notification => {
                    const time = new Date(notification.timestamp || notification.created_at || Date.now()).toLocaleTimeString();
                    const level = notification.level || notification.priority || 'info';
                    const title = notification.title || notification.type || 'Notification';
                    
                    const levelColors = {
                        info: 'bg-primary-500/20 text-primary-400',
                        success: 'bg-success-500/20 text-success-400',
                        warning: 'bg-yellow-500/20 text-yellow-400',
                        error: 'bg-danger-500/20 text-danger-400'
                    };
                    
                    return `
                        <div class="glass-effect rounded-xl p-4 border-l-4 border-primary-500">
                            <div class="flex justify-between items-start mb-2">
                                <span class="px-2 py-1 rounded text-xs font-bold ${levelColors[level] || levelColors.info}">${level.toUpperCase()}</span>
                                <span class="text-xs text-slate-400">${time}</span>
                            </div>
                            <div>
                                <div class="font-semibold text-slate-100">${title}</div>
                                <div class="text-sm text-slate-300 mt-1">${notification.message}</div>
                                ${notification.symbol ? `<div class="text-xs text-slate-400 mt-1">Symbol: ${notification.symbol}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            renderHistoricalNotifications() {
                const container = document.getElementById('historicalNotificationsList');
                const notifications = this.data.notifications.historical.data;
                
                if (!notifications || notifications.length === 0) {
                    container.innerHTML = '<div class="text-center text-slate-400 py-8">No notifications found</div>';
                    return;
                }
                
                container.innerHTML = notifications.map(notification => {
                    const time = new Date(notification.timestamp || notification.created_at || Date.now()).toLocaleString();
                    const level = notification.level || notification.priority || 'info';
                    const title = notification.title || notification.type || 'Notification';
                    
                    const levelColors = {
                        info: 'bg-primary-500/20 text-primary-400',
                        success: 'bg-success-500/20 text-success-400',
                        warning: 'bg-yellow-500/20 text-yellow-400',
                        error: 'bg-danger-500/20 text-danger-400'
                    };
                    
                    return `
                        <div class="glass-effect rounded-xl p-4 border-l-4 border-primary-500">
                            <div class="flex justify-between items-start mb-2">
                                <span class="px-2 py-1 rounded text-xs font-bold ${levelColors[level] || levelColors.info}">${level.toUpperCase()}</span>
                                <span class="text-xs text-slate-400">${time}</span>
                            </div>
                            <div>
                                <div class="font-semibold text-slate-100">${title}</div>
                                <div class="text-sm text-slate-300 mt-1">${notification.message}</div>
                                ${notification.symbol ? `<div class="text-xs text-slate-400 mt-1">Symbol: ${notification.symbol}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                this.renderNotificationsPagination();
            }
            
            renderStrategySignals() {
                const container = document.getElementById('strategySignals');
                const signals = this.data.signals;
                
                if (signals.length === 0) {
                    container.innerHTML = '<div class="text-center text-slate-400 py-8">Waiting for signals...</div>';
                    return;
                }
                
                container.innerHTML = signals.map(signal => {
                    const signalClass = signal.signal?.toLowerCase() || 'hold';
                    const time = new Date(signal.timestamp).toLocaleTimeString();
                    
                    const signalColors = {
                        buy: 'bg-success-500/20 text-success-400',
                        sell: 'bg-danger-500/20 text-danger-400',
                        hold: 'bg-yellow-500/20 text-yellow-400'
                    };
                    
                    return `
                        <div class="glass-effect rounded-xl p-4 border-l-4 border-yellow-500">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="font-bold text-slate-100">${signal.symbol}</div>
                                    <div class="text-sm text-slate-400">${signal.strategy_name} • ${time}</div>
                                </div>
                                <span class="px-3 py-1 rounded-full text-sm font-bold ${signalColors[signalClass] || signalColors.hold}">
                                    ${signal.signal}
                                </span>
                            </div>
                            <div class="text-sm text-slate-300">
                                Confidence: ${signal.confidence}%
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            renderHistoricalSignals() {
                const container = document.getElementById('historicalSignalsList');
                const signals = this.data.signalsData.historical.data;
                
                if (!signals || signals.length === 0) {
                    container.innerHTML = '<div class="text-center text-slate-400 py-8">No historical signals found</div>';
                    return;
                }
                
                container.innerHTML = signals.map(signal => {
                    const signalClass = signal.signal?.toLowerCase() || 'hold';
                    const time = new Date(signal.timestamp || signal.created_at).toLocaleString();
                    
                    const signalColors = {
                        buy: 'bg-success-500/20 text-success-400',
                        sell: 'bg-danger-500/20 text-danger-400',
                        hold: 'bg-yellow-500/20 text-yellow-400'
                    };
                    
                    return `
                        <div class="glass-effect rounded-xl p-4 border-l-4 border-yellow-500">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="font-bold text-slate-100">${signal.symbol}</div>
                                    <div class="text-sm text-slate-400">${signal.strategy_name} • ${time}</div>
                                </div>
                                <span class="px-3 py-1 rounded-full text-sm font-bold ${signalColors[signalClass] || signalColors.hold}">
                                    ${signal.signal}
                                </span>
                            </div>
                            <div class="text-sm text-slate-300">
                                Confidence: ${signal.confidence}%
                            </div>
                        </div>
                    `;
                }).join('');
                
                this.renderSignalsPagination();
            }
            
            renderAccountSummary() {
                const container = document.getElementById('accountSummary');
                const summary = this.data.accountSummary;
                
                if (!summary || Object.keys(summary).length === 0) {
                    container.innerHTML = `
                        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4">
                            ${Array(6).fill().map(() => `
                                <div class="glass-effect rounded-xl p-4 text-center">
                                    <div class="loading-skeleton h-4 w-20 mx-auto mb-2 rounded"></div>
                                    <div class="loading-skeleton h-6 w-16 mx-auto rounded"></div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    return;
                }
                
                const accountGrowth = summary.account_growth || 0;
                const accountGrowthPct = summary.account_growth_percentage || 0;
                const totalPnl = (summary.realized_pnl || 0) + (summary.unrealized_pnl || 0); // Fixed: Total P&L = Realized + Unrealized
                const unrealizedPnl = summary.unrealized_pnl || 0;
                const realizedPnl = summary.realized_pnl || 0;
                const marginUsagePct = summary.margin_usage_percentage || 0;
                
                container.innerHTML = `
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4">
                        <div class="glass-effect rounded-xl p-4 text-center border-l-4 border-primary-500">
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Current Balance</div>
                            <div class="text-xl font-bold font-mono">$${this.formatNumber(summary.current_balance || 0)}</div>
                            <div class="text-xs text-slate-500 mt-1">Initial: $${this.formatNumber(summary.initial_balance || 0)}</div>
                        </div>
                        <div class="glass-effect rounded-xl p-4 text-center border-l-4 ${accountGrowth >= 0 ? 'border-success-500' : 'border-danger-500'}">
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Account Growth</div>
                            <div class="text-xl font-bold font-mono ${accountGrowth >= 0 ? 'positive' : 'negative'}">
                                ${accountGrowth >= 0 ? '+' : ''}$${Math.abs(accountGrowth).toFixed(2)}
                            </div>
                            <div class="text-xs ${accountGrowth >= 0 ? 'positive' : 'negative'}">
                                ${accountGrowthPct >= 0 ? '+' : ''}${accountGrowthPct.toFixed(2)}%
                            </div>
                        </div>
                        <div class="glass-effect rounded-xl p-4 text-center border-l-4 border-yellow-500">
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Margin Used</div>
                            <div class="text-xl font-bold font-mono">$${this.formatNumber(summary.margin_used || 0)}</div>
                            <div class="text-xs text-slate-400">${marginUsagePct.toFixed(1)}% of balance</div>
                        </div>
                        <div class="glass-effect rounded-xl p-4 text-center border-l-4 ${realizedPnl >= 0 ? 'border-success-500' : 'border-danger-500'}">
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Realized P&L</div>
                            <div class="text-xl font-bold font-mono ${realizedPnl >= 0 ? 'positive' : 'negative'}">
                                ${realizedPnl >= 0 ? '+' : ''}$${Math.abs(realizedPnl).toFixed(2)}
                            </div>
                            <div class="text-xs ${realizedPnl >= 0 ? 'text-success-400' : 'text-danger-400'} mt-1">
                                ${summary.initial_balance > 0 ? (realizedPnl >= 0 ? '+' : '') + (realizedPnl / summary.initial_balance * 100).toFixed(2) + '%' : 'N/A'}
                            </div>
                        </div>
                        <div class="glass-effect rounded-xl p-4 text-center border-l-4 ${unrealizedPnl >= 0 ? 'border-success-500' : 'border-danger-500'}">
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Unrealized P&L</div>
                            <div class="text-xl font-bold font-mono ${unrealizedPnl >= 0 ? 'positive' : 'negative'}">
                                ${unrealizedPnl >= 0 ? '+' : ''}$${Math.abs(unrealizedPnl).toFixed(2)}
                            </div>
                            <div class="text-xs ${unrealizedPnl >= 0 ? 'text-success-400' : 'text-danger-400'} mt-1">
                                ${summary.initial_balance > 0 ? (unrealizedPnl >= 0 ? '+' : '') + (unrealizedPnl / summary.initial_balance * 100).toFixed(2) + '%' : 'N/A'}
                            </div>
                        </div>
                        <div class="glass-effect rounded-xl p-4 text-center border-l-4 ${totalPnl >= 0 ? 'border-success-500' : 'border-danger-500'}">
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Total P&L</div>
                            <div class="text-xl font-bold font-mono ${totalPnl >= 0 ? 'positive' : 'negative'}">
                                ${totalPnl >= 0 ? '+' : ''}$${Math.abs(totalPnl).toFixed(2)}
                            </div>
                        </div>
                        <div class="glass-effect rounded-xl p-4 text-center border-l-4 border-slate-500">
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Positions</div>
                            <div class="text-xl font-bold font-mono">${summary.open_positions_count || 0}/${summary.closed_positions_count || 0}</div>
                            <div class="text-xs text-slate-400">Open/Closed</div>
                        </div>
                        <div class="glass-effect rounded-xl p-4 text-center border-l-4 border-purple-500">
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Win Rate</div>
                            <div class="text-xl font-bold font-mono">${(summary.win_rate || 0).toFixed(1)}%</div>
                        </div>
                        <div class="glass-effect rounded-xl p-4 text-center border-l-4 border-orange-500">
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Daily Trades</div>
                            <div class="text-xl font-bold font-mono">${summary.daily_trades_count || 0}</div>
                            <div class="text-xs text-slate-400">of ${summary.daily_trades_limit || 50}</div>
                        </div>
                        <div class="glass-effect rounded-xl p-4 text-center border-l-4 border-cyan-500">
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Total Profit/Loss</div>
                            <div class="text-sm font-bold font-mono">
                                <span class="positive">+$${this.formatNumber(summary.total_positive_pnl || 0)}</span> / 
                                <span class="negative">-$${this.formatNumber(Math.abs(summary.total_negative_pnl || 0))}</span>
                            </div>
                        </div>
                        <div class="glass-effect rounded-xl p-4 text-center border-l-4 border-red-500">
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Brokerage</div>
                            <div class="text-xl font-bold font-mono">$${this.formatNumber(summary.brokerage_charges || 0)}</div>
                        </div>
                    </div>
                `;
            }
            
            // Pagination methods
            renderPositionsTabPagination() {
                const container = document.getElementById('positionsPagination');
                const pagination = this.data.positionsTabData.pagination;
                
                if (!pagination || pagination.pages <= 1) {
                    container.innerHTML = '';
                    return;
                }
                
                let paginationHtml = '';
                
                paginationHtml += `<button class="px-3 py-1 rounded bg-slate-700 text-slate-300 hover:bg-slate-600 disabled:opacity-50" ${pagination.page <= 1 ? 'disabled' : ''} onclick="dashboard.loadClosedPositionsForTab(${pagination.page - 1})">Previous</button>`;
                
                for (let i = Math.max(1, pagination.page - 2); i <= Math.min(pagination.pages, pagination.page + 2); i++) {
                    paginationHtml += `<button class="px-3 py-1 rounded ${i === pagination.page ? 'bg-primary-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}" onclick="dashboard.loadClosedPositionsForTab(${i})">${i}</button>`;
                }
                
                paginationHtml += `<button class="px-3 py-1 rounded bg-slate-700 text-slate-300 hover:bg-slate-600 disabled:opacity-50" ${pagination.page >= pagination.pages ? 'disabled' : ''} onclick="dashboard.loadClosedPositionsForTab(${pagination.page + 1})">Next</button>`;
                
                container.innerHTML = paginationHtml;
            }
            
            renderTradesInTabPagination() {
                const container = document.getElementById('tradesTabPagination');
                const pagination = this.data.tradesTabData.pagination;
                
                if (!pagination || pagination.pages <= 1) {
                    container.innerHTML = '';
                    return;
                }
                
                let paginationHtml = '';
                
                paginationHtml += `<button class="px-3 py-1 rounded bg-slate-700 text-slate-300 hover:bg-slate-600 disabled:opacity-50" ${pagination.page <= 1 ? 'disabled' : ''} onclick="dashboard.loadTradesForTab(${pagination.page - 1})">Previous</button>`;
                
                for (let i = Math.max(1, pagination.page - 2); i <= Math.min(pagination.pages, pagination.page + 2); i++) {
                    paginationHtml += `<button class="px-3 py-1 rounded ${i === pagination.page ? 'bg-primary-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}" onclick="dashboard.loadTradesForTab(${i})">${i}</button>`;
                }
                
                paginationHtml += `<button class="px-3 py-1 rounded bg-slate-700 text-slate-300 hover:bg-slate-600 disabled:opacity-50" ${pagination.page >= pagination.pages ? 'disabled' : ''} onclick="dashboard.loadTradesForTab(${pagination.page + 1})">Next</button>`;
                
                container.innerHTML = paginationHtml;
            }
            
            renderNotificationsPagination() {
                const container = document.getElementById('notificationsPagination');
                const pagination = this.data.notifications.historical.pagination;
                
                if (!pagination || pagination.pages <= 1) {
                    container.innerHTML = '';
                    return;
                }
                
                let paginationHtml = '';
                
                paginationHtml += `<button class="px-3 py-1 rounded bg-slate-700 text-slate-300 hover:bg-slate-600 disabled:opacity-50" ${pagination.page <= 1 ? 'disabled' : ''} onclick="dashboard.loadHistoricalNotifications(${pagination.page - 1})">Previous</button>`;
                
                for (let i = Math.max(1, pagination.page - 2); i <= Math.min(pagination.pages, pagination.page + 2); i++) {
                    paginationHtml += `<button class="px-3 py-1 rounded ${i === pagination.page ? 'bg-primary-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}" onclick="dashboard.loadHistoricalNotifications(${i})">${i}</button>`;
                }
                
                paginationHtml += `<button class="px-3 py-1 rounded bg-slate-700 text-slate-300 hover:bg-slate-600 disabled:opacity-50" ${pagination.page >= pagination.pages ? 'disabled' : ''} onclick="dashboard.loadHistoricalNotifications(${pagination.page + 1})">Next</button>`;
                
                container.innerHTML = paginationHtml;
            }
            
            renderSignalsPagination() {
                const container = document.getElementById('signalsPagination');
                const pagination = this.data.signalsData.historical.pagination;
                
                if (!pagination || pagination.pages <= 1) {
                    container.innerHTML = '';
                    return;
                }
                
                let paginationHtml = '';
                
                paginationHtml += `<button class="px-3 py-1 rounded bg-slate-700 text-slate-300 hover:bg-slate-600 disabled:opacity-50" ${pagination.page <= 1 ? 'disabled' : ''} onclick="dashboard.loadHistoricalSignals(${pagination.page - 1})">Previous</button>`;
                
                for (let i = Math.max(1, pagination.page - 2); i <= Math.min(pagination.pages, pagination.page + 2); i++) {
                    paginationHtml += `<button class="px-3 py-1 rounded ${i === pagination.page ? 'bg-primary-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}" onclick="dashboard.loadHistoricalSignals(${i})">${i}</button>`;
                }
                
                paginationHtml += `<button class="px-3 py-1 rounded bg-slate-700 text-slate-300 hover:bg-slate-600 disabled:opacity-50" ${pagination.page >= pagination.pages ? 'disabled' : ''} onclick="dashboard.loadHistoricalSignals(${pagination.page + 1})">Next</button>`;
                
                container.innerHTML = paginationHtml;
            }
            
            // Utility methods
            updateConnectionStatus(status) {
                const statusElement = document.getElementById('connectionStatus');
                const connectBtn = document.getElementById('connectBtn');
                const disconnectBtn = document.getElementById('disconnectBtn');
                
                statusElement.className = 'px-4 py-2 rounded-full text-sm font-semibold border';
                
                switch (status) {
                    case 'connected':
                        statusElement.className += ' bg-success-500/20 text-success-400 border-success-500/30';
                        statusElement.innerHTML = '<span class="inline-block w-2 h-2 bg-success-400 rounded-full animate-pulse mr-2"></span>Connected';
                        connectBtn.disabled = true;
                        disconnectBtn.disabled = false;
                        document.getElementById('systemStatus').textContent = 'Online';
                        document.getElementById('statusIndicator').classList.remove('text-danger-500');
                        document.getElementById('statusIndicator').classList.add('text-success-500');
                        break;
                    case 'connecting':
                        statusElement.className += ' bg-yellow-500/20 text-yellow-400 border-yellow-500/30';
                        statusElement.innerHTML = '<span class="inline-block w-2 h-2 bg-yellow-400 rounded-full animate-pulse mr-2"></span>Connecting...';
                        connectBtn.disabled = true;
                        disconnectBtn.disabled = true;
                        document.getElementById('systemStatus').textContent = 'Connecting...';
                        break;
                    case 'disconnected':
                        statusElement.className += ' bg-danger-500/20 text-danger-400 border-danger-500/30';
                        statusElement.innerHTML = '<span class="inline-block w-2 h-2 bg-danger-400 rounded-full mr-2"></span>Disconnected';
                        connectBtn.disabled = false;
                        disconnectBtn.disabled = true;
                        document.getElementById('systemStatus').textContent = 'Offline';
                        document.getElementById('statusIndicator').classList.remove('text-success-500');
                        document.getElementById('statusIndicator').classList.add('text-danger-500');
                        break;
                }
            }
            
            connect() {
                if (this.isConnected || this.isConnecting || this.isReconnecting) {
                    return;
                }
                
                console.log('🔌 Manual connect requested');
                this.reconnectAttempts = 0;
                this.updateConnectionStatus('connecting');
                this.connectWebSocket();
            }
            
            disconnect() {
                console.log('🔌 Manual disconnect requested');
                
                this.reconnectAttempts = this.maxReconnectAttempts;
                this.cleanupConnection();
                
                this.isConnected = false;
                this.isConnecting = false;
                this.isReconnecting = false;
                this.connectionMutex = false;
                this.subscribed = false;
                this.updateConnectionStatus('disconnected');
            }
            
            scheduleReconnect() {
                if (this.isConnecting || this.isReconnecting || this.reconnectAttempts >= this.maxReconnectAttempts) {
                    return;
                }
                
                this.reconnectAttempts++;
                const delay = Math.min(this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1), 60000);
                
                console.log(`⏰ Scheduling reconnect attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts} in ${delay}ms`);
                
                if (this.reconnectTimeoutId) {
                    clearTimeout(this.reconnectTimeoutId);
                }
                
                this.reconnectTimeoutId = setTimeout(() => {
                    if (!this.isConnected && !this.isConnecting && !this.isReconnecting) {
                        console.log(`🔄 Attempting reconnect ${this.reconnectAttempts}/${this.maxReconnectAttempts}`);
                        this.isReconnecting = true;
                        this.updateConnectionStatus('connecting');
                        this.connectWebSocket();
                    }
                }, delay);
            }
            
            setupEventListeners() {
                // Position tab buttons
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const tab = e.target.dataset.tab;
                        if (tab) {
                            this.switchPositionTab(tab);
                        }
                    });
                });
                
                // Notification tab buttons
                document.querySelectorAll('.notification-tab-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const tab = e.target.dataset.tab;
                        if (tab) {
                            this.switchNotificationTab(tab);
                        }
                    });
                });
                
                // Signal tab buttons
                document.querySelectorAll('.signal-tab-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const tab = e.target.dataset.tab;
                        if (tab) {
                            this.switchSignalTab(tab);
                        }
                    });
                });
                
                // Filter event listeners
                const filterIds = [
                    'applyPositionsFilters', 'clearPositionsFilters',
                    'applyTradesFilters', 'clearTradesFilters',
                    'applyNotificationFilters', 'clearNotificationFilters',
                    'applySignalsFilters', 'clearSignalsFilters'
                ];
                
                filterIds.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('click', () => {
                            const action = id.replace(/Filters$/, '').replace(/apply|clear/, '');
                            if (id.startsWith('apply')) {
                                this[`apply${action}Filters`]();
                            } else {
                                this[`clear${action}Filters`]();
                            }
                        });
                    }
                });
                
                // Modal event listeners
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeReadme();
                    }
                });
                
                // Page visibility handlers
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden && !this.isConnected && !this.isConnecting && !this.isReconnecting && this.reconnectAttempts < this.maxReconnectAttempts) {
                        setTimeout(() => {
                            if (!this.isConnected && !this.isConnecting && !this.isReconnecting) {
                                this.scheduleReconnect();
                            }
                        }, 3000);
                    }
                });
                
                window.addEventListener('beforeunload', () => {
                    this.cleanupConnection();
                    if (this.sseSource) {
                        this.sseSource.close();
                    }
                });
            }
            
            // Filter methods
            applyPositionsFilters() {
                const filters = {
                    date_from: document.getElementById('positionsDateFrom').value,
                    date_to: document.getElementById('positionsDateTo').value,
                    symbol: document.getElementById('positionsSymbolFilter').value,
                    strategy: document.getElementById('positionsStrategyFilter').value,
                    position_type: document.getElementById('positionsTypeFilter').value,
                    search: document.getElementById('positionsSearchFilter').value
                };

                Object.keys(filters).forEach(key => {
                    if (!filters[key]) delete filters[key];
                });

                this.data.positionsTabFilters = filters;
                this.loadClosedPositionsForTab(1);
            }

            clearPositionsFilters() {
                document.getElementById('positionsDateFrom').value = '';
                document.getElementById('positionsDateTo').value = '';
                document.getElementById('positionsSymbolFilter').value = '';
                document.getElementById('positionsStrategyFilter').value = '';
                document.getElementById('positionsTypeFilter').value = '';
                document.getElementById('positionsSearchFilter').value = '';
                
                this.data.positionsTabFilters = {};
                this.loadClosedPositionsForTab(1);
            }

            applyTradesFilters() {
                const filters = {
                    date_from: document.getElementById('tradesDateFrom').value,
                    date_to: document.getElementById('tradesDateTo').value,
                    symbol: document.getElementById('tradesSymbolFilter').value,
                    strategy: document.getElementById('tradesStrategyFilter').value,
                    type: document.getElementById('tradesTypeFilter').value,
                    search: document.getElementById('tradesSearchFilter').value
                };
                
                Object.keys(filters).forEach(key => {
                    if (!filters[key]) delete filters[key];
                });

                this.data.tradesTabFilters = filters;
                this.loadTradesForTab(1);
            }

            clearTradesFilters() {
                document.getElementById('tradesDateFrom').value = '';
                document.getElementById('tradesDateTo').value = '';
                document.getElementById('tradesSymbolFilter').value = '';
                document.getElementById('tradesStrategyFilter').value = '';
                document.getElementById('tradesTypeFilter').value = '';
                document.getElementById('tradesSearchFilter').value = '';
                
                this.data.tradesTabFilters = {};
                this.loadTradesForTab(1);
            }

            applyNotificationFilters() {
                const filters = {
                    date_from: document.getElementById('notificationDateFrom').value,
                    date_to: document.getElementById('notificationDateTo').value,
                    level: document.getElementById('notificationLevelFilter').value,
                    notification_type: document.getElementById('notificationTypeFilter').value,
                    search: document.getElementById('notificationSearchFilter').value
                };

                Object.keys(filters).forEach(key => {
                    if (!filters[key]) delete filters[key];
                });

                this.data.notifications.historical.filters = filters;
                this.loadHistoricalNotifications(1);
            }

            clearNotificationFilters() {
                document.getElementById('notificationDateFrom').value = '';
                document.getElementById('notificationDateTo').value = '';
                document.getElementById('notificationLevelFilter').value = '';
                document.getElementById('notificationTypeFilter').value = '';
                document.getElementById('notificationSearchFilter').value = '';
                
                this.data.notifications.historical.filters = {};
                this.loadHistoricalNotifications(1);
            }

            applySignalsFilters() {
                const filters = {
                    date_from: document.getElementById('signalsDateFrom').value,
                    date_to: document.getElementById('signalsDateTo').value,
                    symbol: document.getElementById('signalsSymbolFilter').value,
                    strategy: document.getElementById('signalsStrategyFilter').value
                };

                Object.keys(filters).forEach(key => {
                    if (!filters[key]) delete filters[key];
                });

                this.data.signalsData.historical.filters = filters;
                this.loadHistoricalSignals(1);
            }

            clearSignalsFilters() {
                document.getElementById('signalsDateFrom').value = '';
                document.getElementById('signalsDateTo').value = '';
                document.getElementById('signalsSymbolFilter').value = '';
                document.getElementById('signalsStrategyFilter').value = '';
                
                this.data.signalsData.historical.filters = {};
                this.loadHistoricalSignals(1);
            }
            
            formatPrice(price) {
                return parseFloat(price).toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 6
                });
            }
            
            formatNumber(num) {
                return parseFloat(num).toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 2
                });
            }
            
            formatUptime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = Math.floor(seconds % 60);
                return `${hours}h ${minutes}m ${secs}s`;
            }
            
            flashUpdateIndicator(indicatorId) {
                const indicator = document.getElementById(indicatorId);
                if (indicator) {
                    indicator.classList.remove('opacity-0');
                    indicator.classList.add('opacity-100');
                    setTimeout(() => {
                        indicator.classList.remove('opacity-100');
                        indicator.classList.add('opacity-0');
                    }, 500);
                }
            }
            
            showErrorState(containerId, message) {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `
                        <div class="text-center text-danger-400 py-8">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <p>${message}</p>
                        </div>
                    `;
                }
            }
            
            showReadme() {
                const modal = document.getElementById('readmeModal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.body.style.overflow = 'hidden';
            }
            
            closeReadme() {
                const modal = document.getElementById('readmeModal');
                modal.classList.remove('flex');
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            if (window.dashboard) {
                console.log('⚠️ Dashboard already exists, skipping initialization');
                return;
            }
            
            console.log('🚀 Initializing Advanced Trading Dashboard...');
            window.dashboard = new TradingDashboard();
        });

        // Global functions for onclick handlers
        window.switchPositionTab = function(tab) {
            if (window.dashboard && window.dashboard.switchPositionTab) {
                window.dashboard.switchPositionTab(tab);
            }
        };

        window.switchSignalTab = function(tab) {
            if (window.dashboard && window.dashboard.switchSignalTab) {
                window.dashboard.switchSignalTab(tab);
            }
        };

        window.switchNotificationTab = function(tab) {
            if (window.dashboard && window.dashboard.switchNotificationTab) {
                window.dashboard.switchNotificationTab(tab);
            }
        };

        window.showReadme = function() {
            if (window.dashboard && window.dashboard.showReadme) {
                window.dashboard.showReadme();
            }
        };

        window.closeReadme = function() {
            if (window.dashboard && window.dashboard.closeReadme) {
                window.dashboard.closeReadme();
            }
        };

        window.openReadmeInNewPage = function() {
            // Create a new window/tab with the README content
            const readmeWindow = window.open('', '_blank');
            const htmlContent = 
                '<html>' +
                '<head>' +
                '<title>Trading System Documentation</title>' +
                '<style>' +
                'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; line-height: 1.6; max-width: 1200px; margin: 0 auto; padding: 20px; background: #0f172a; color: #e2e8f0; }' +
                'h1, h2, h3 { color: #60a5fa; }' +
                'code { background: #1e293b; padding: 2px 4px; border-radius: 3px; }' +
                'pre { background: #1e293b; padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; }' +
                'blockquote { border-left: 4px solid #60a5fa; margin: 0; padding-left: 20px; }' +
                'a { color: #60a5fa; }' +
                '</style>' +
                '</head>' +
                '<body>' +
                '<div id="readme-content">Loading README...</div>' +
                '<script>' +
                'fetch("/README.md")' +
                '.then(function(response) { return response.text(); })' +
                '.then(function(text) {' +
                'var escapedText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");' +
                'document.getElementById("readme-content").innerHTML = "<pre>" + escapedText + "</pre>";' +
                '})' +
                '.catch(function(error) {' +
                'document.getElementById("readme-content").innerHTML = "<h1>Trading System Documentation</h1><p>Please refer to the README.md file in the project root directory for complete documentation.</p>";' +
                '});' +
                '</' + 'script>' +
                '</body>' +
                '</html>';
            readmeWindow.document.write(htmlContent);
            readmeWindow.document.close();
        };

        window.connect = function() {
            if (window.dashboard && window.dashboard.connect) {
                window.dashboard.connect();
            }
        };

        window.disconnect = function() {
            if (window.dashboard && window.dashboard.disconnect) {
                window.dashboard.disconnect();
            }
        };
    </script>
</body>
</html>